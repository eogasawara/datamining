

# Clustering

## Visão Geral
Clustering é aprendizado não supervisionado que agrupa observações por similaridade. A qualidade depende de escolha de métricas, escalas e do algoritmo.  

## Como ler este roteiro
Use a sequência abaixo para interpretar melhor os resultados:
1. escolha do paradigma (particional, hierárquico, densidade, probabilístico);
2. efeito de escala/normalização;
3. avaliação e seleção do modelo.


``` r
# Forma mais simples de usar clustering no daltoolbox: instalando pacotes basicos
#install.packages("daltoolbox")
#install.packages("ggplot2")
#install.packages("cluster")
#install.packages("mclust")
#install.packages("e1071")
#install.packages("igraph")
```

Slides: 1–12.

## Configuração


``` r
  library(daltoolbox)
  library(ggplot2)
  library(cluster)
  library(mclust)
  library(e1071)
  library(igraph)
```

Com o ambiente pronto, carregamos o conjunto de dados base e isolamos apenas atributos numéricos para clustering.


``` r
# Slides 4: conjunto de dados de exemplo
iris <- datasets::iris
head(iris)
```

```
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa
```

``` r
# Preparacao
X <- iris[, 1:4]
```

## K-means
Algoritmo de particionamento que minimiza a variância intra-cluster. Sensível a escala e outliers.  
Slides: 25–29.


``` r
# Slides 25–29: K-means
model_km <- cluster_kmeans(k = 3)
model_km <- daltoolbox::fit(model_km, X)
clu_km <- daltoolbox::cluster(model_km, X)
table(clu_km)
```

```
## clu_km
##  1  2  3 
## 62 38 50
```

``` r
eval_km <- daltoolbox::evaluate(model_km, clu_km, iris$Species)
eval_km
```

```
## $clusters_entropy
## # A tibble: 3 × 4
##   x        ce   qtd    ceg
##   <fct> <dbl> <int>  <dbl>
## 1 1     0.771    62 0.319 
## 2 2     0.297    38 0.0754
## 3 3     0        50 0     
## 
## $clustering_entropy
## [1] 0.3938863
## 
## $data_entropy
## [1] 1.584963
```

### Normalização
Normalização reduz o efeito de escalas diferentes e pode melhorar a separação.  
Slides: 29.


``` r
# Slides 29: normalizacao
iris_minmax <- transform(daltoolbox::fit(minmax(), iris), iris)
model_km <- daltoolbox::fit(model_km, iris_minmax[, 1:4])
clu_km <- daltoolbox::cluster(model_km, iris_minmax[, 1:4])
eval_km_norm <- daltoolbox::evaluate(model_km, clu_km, iris_minmax$Species)
eval_km_norm
```

```
## $clusters_entropy
## # A tibble: 3 × 4
##   x        ce   qtd   ceg
##   <fct> <dbl> <int> <dbl>
## 1 1     0.391    39 0.102
## 2 2     0        50 0    
## 3 3     0.777    61 0.316
## 
## $clustering_entropy
## [1] 0.4177655
## 
## $data_entropy
## [1] 1.584963
```

## K-medoids (PAM)
Semelhante ao k-means, mas usa medoids (pontos reais) como centros, sendo mais robusto a outliers.  
Slides: 30–31.


``` r
# Slides 30–31: K-medoids (PAM)
model_pam <- cluster_pam(k = 3)
model_pam <- daltoolbox::fit(model_pam, X)
clu_pam <- daltoolbox::cluster(model_pam, X)
table(clu_pam)
```

```
## clu_pam
##  1  2  3 
## 50 62 38
```

``` r
eval_pam <- daltoolbox::evaluate(model_pam, clu_pam, iris$Species)
eval_pam
```

```
## $clusters_entropy
## # A tibble: 3 × 4
##   x        ce   qtd    ceg
##   <fct> <dbl> <int>  <dbl>
## 1 1     0        50 0     
## 2 2     0.771    62 0.319 
## 3 3     0.297    38 0.0754
## 
## $clustering_entropy
## [1] 0.3938863
## 
## $data_entropy
## [1] 1.584963
```

## Clustering Hierárquico
Constrói uma árvore de agrupamentos (dendrograma). Pode ser aglomerativo (bottom-up) ou divisivo (top-down).  
Slides: 32–35.


``` r
# Slides 32–35: clustering hierarquico e dendrograma (R base)
# Distancia euclidiana e metodo de Ward
model_hc <- cluster_hclust(k = 3, method = "ward.D2", dist = "euclidean", scale = TRUE)
model_hc <- daltoolbox::fit(model_hc, X)
plot(model_hc[["hc"]])
```

![plot of chunk s32_35_hclust](fig/10-Clustering/s32_35_hclust-1.png)

``` r
# Cortando em 3 grupos
hc_groups <- daltoolbox::cluster(model_hc, X)
table(hc_groups)
```

```
## hc_groups
##  1  2  3 
## 49 30 71
```

## DBSCAN
Método baseado em densidade que detecta clusters de formato arbitrário e identifica ruído.  
Slides: 36–41.


``` r
# Slides 36–41: DBSCAN
model_db <- cluster_dbscan(minPts = 3)
model_db <- daltoolbox::fit(model_db, X)
clu_db <- daltoolbox::cluster(model_db, X)
table(clu_db)
```

```
## clu_db
##  0  1  2  3  4 
## 26 47 38  4 35
```

``` r
eval_db <- daltoolbox::evaluate(model_db, clu_db, iris$Species)
eval_db
```

```
## $clusters_entropy
## # A tibble: 5 × 4
##   x        ce   qtd    ceg
##   <fct> <dbl> <int>  <dbl>
## 1 0     1.18     26 0.205 
## 2 1     0        47 0     
## 3 2     0        38 0     
## 4 3     0         4 0     
## 5 4     0.422    35 0.0985
## 
## $clustering_entropy
## [1] 0.3037218
## 
## $data_entropy
## [1] 1.584963
```

## Avaliação e Seleção de Modelos
Critérios externos podem ser usados quando rótulos são conhecidos. Ajuste de hiperparâmetros ajuda a escolher k.  
Slides: 42–45.


``` r
# Slides 42–45: avaliacao e escolha de modelos
# Ajuste automatico de k para k-means
model_tune <- clu_tune(cluster_kmeans(k = 0), ranges = list(k = 2:10))
model_tune <- daltoolbox::fit(model_tune, X)
model_tune$k
```

```
## [1] 7
```

``` r
clu_tune <- daltoolbox::cluster(model_tune, X)
eval_tune <- daltoolbox::evaluate(model_tune, clu_tune, iris$Species)
eval_tune
```

```
## $clusters_entropy
## # A tibble: 7 × 4
##   x        ce   qtd    ceg
##   <fct> <dbl> <int>  <dbl>
## 1 1     0        19 0     
## 2 2     0         8 0     
## 3 3     0.918    39 0.239 
## 4 4     0        12 0     
## 5 5     0.242    25 0.0404
## 6 6     0        24 0     
## 7 7     0        23 0     
## 
## $clustering_entropy
## [1] 0.2791389
## 
## $data_entropy
## [1] 1.584963
```

## Clustering Probabilístico (GMM)
Modelos de mistura assumem que os dados vêm de distribuições (ex.: Gaussianas). O EM estima parâmetros e probabilidades a posteriori.  
Slides: 47–56.


``` r
# Slides 47–56: clustering probabilistico (GMM via mclust)
set.seed(1)
model_gmm <- cluster_gmm()
model_gmm <- daltoolbox::fit(model_gmm, X)
```

```
## fitting ...
## 
  |                                                                                                                                            
  |                                                                                                                                      |   0%
  |                                                                                                                                            
  |=                                                                                                                                     |   1%
  |                                                                                                                                            
  |==                                                                                                                                    |   2%
  |                                                                                                                                            
  |===                                                                                                                                   |   2%
  |                                                                                                                                            
  |====                                                                                                                                  |   3%
  |                                                                                                                                            
  |=====                                                                                                                                 |   4%
  |                                                                                                                                            
  |======                                                                                                                                |   5%
  |                                                                                                                                            
  |=======                                                                                                                               |   6%
  |                                                                                                                                            
  |========                                                                                                                              |   6%
  |                                                                                                                                            
  |=========                                                                                                                             |   7%
  |                                                                                                                                            
  |===========                                                                                                                           |   8%
  |                                                                                                                                            
  |============                                                                                                                          |   9%
  |                                                                                                                                            
  |=============                                                                                                                         |   9%
  |                                                                                                                                            
  |==============                                                                                                                        |  10%
  |                                                                                                                                            
  |===============                                                                                                                       |  11%
  |                                                                                                                                            
  |================                                                                                                                      |  12%
  |                                                                                                                                            
  |=================                                                                                                                     |  13%
  |                                                                                                                                            
  |==================                                                                                                                    |  13%
  |                                                                                                                                            
  |===================                                                                                                                   |  14%
  |                                                                                                                                            
  |====================                                                                                                                  |  15%
  |                                                                                                                                            
  |=====================                                                                                                                 |  16%
  |                                                                                                                                            
  |======================                                                                                                                |  17%
  |                                                                                                                                            
  |=======================                                                                                                               |  17%
  |                                                                                                                                            
  |========================                                                                                                              |  18%
  |                                                                                                                                            
  |=========================                                                                                                             |  19%
  |                                                                                                                                            
  |==========================                                                                                                            |  20%
  |                                                                                                                                            
  |===========================                                                                                                           |  20%
  |                                                                                                                                            
  |============================                                                                                                          |  21%
  |                                                                                                                                            
  |==============================                                                                                                        |  22%
  |                                                                                                                                            
  |===============================                                                                                                       |  23%
  |                                                                                                                                            
  |================================                                                                                                      |  24%
  |                                                                                                                                            
  |=================================                                                                                                     |  24%
  |                                                                                                                                            
  |==================================                                                                                                    |  25%
  |                                                                                                                                            
  |===================================                                                                                                   |  26%
  |                                                                                                                                            
  |====================================                                                                                                  |  27%
  |                                                                                                                                            
  |=====================================                                                                                                 |  28%
  |                                                                                                                                            
  |======================================                                                                                                |  28%
  |                                                                                                                                            
  |=======================================                                                                                               |  29%
  |                                                                                                                                            
  |========================================                                                                                              |  30%
  |                                                                                                                                            
  |=========================================                                                                                             |  31%
  |                                                                                                                                            
  |==========================================                                                                                            |  31%
  |                                                                                                                                            
  |===========================================                                                                                           |  32%
  |                                                                                                                                            
  |============================================                                                                                          |  33%
  |                                                                                                                                            
  |=============================================                                                                                         |  34%
  |                                                                                                                                            
  |==============================================                                                                                        |  35%
  |                                                                                                                                            
  |===============================================                                                                                       |  35%
  |                                                                                                                                            
  |=================================================                                                                                     |  36%
  |                                                                                                                                            
  |==================================================                                                                                    |  37%
  |                                                                                                                                            
  |===================================================                                                                                   |  38%
  |                                                                                                                                            
  |====================================================                                                                                  |  39%
  |                                                                                                                                            
  |=====================================================                                                                                 |  39%
  |                                                                                                                                            
  |======================================================                                                                                |  40%
  |                                                                                                                                            
  |=======================================================                                                                               |  41%
  |                                                                                                                                            
  |========================================================                                                                              |  42%
  |                                                                                                                                            
  |=========================================================                                                                             |  43%
  |                                                                                                                                            
  |==========================================================                                                                            |  43%
  |                                                                                                                                            
  |===========================================================                                                                           |  44%
  |                                                                                                                                            
  |============================================================                                                                          |  45%
  |                                                                                                                                            
  |=============================================================                                                                         |  46%
  |                                                                                                                                            
  |==============================================================                                                                        |  46%
  |                                                                                                                                            
  |===============================================================                                                                       |  47%
  |                                                                                                                                            
  |================================================================                                                                      |  48%
  |                                                                                                                                            
  |=================================================================                                                                     |  49%
  |                                                                                                                                            
  |==================================================================                                                                    |  50%
  |                                                                                                                                            
  |====================================================================                                                                  |  50%
  |                                                                                                                                            
  |=====================================================================                                                                 |  51%
  |                                                                                                                                            
  |======================================================================                                                                |  52%
  |                                                                                                                                            
  |=======================================================================                                                               |  53%
  |                                                                                                                                            
  |========================================================================                                                              |  54%
  |                                                                                                                                            
  |=========================================================================                                                             |  54%
  |                                                                                                                                            
  |==========================================================================                                                            |  55%
  |                                                                                                                                            
  |===========================================================================                                                           |  56%
  |                                                                                                                                            
  |============================================================================                                                          |  57%
  |                                                                                                                                            
  |=============================================================================                                                         |  57%
  |                                                                                                                                            
  |==============================================================================                                                        |  58%
  |                                                                                                                                            
  |===============================================================================                                                       |  59%
  |                                                                                                                                            
  |================================================================================                                                      |  60%
  |                                                                                                                                            
  |=================================================================================                                                     |  61%
  |                                                                                                                                            
  |==================================================================================                                                    |  61%
  |                                                                                                                                            
  |===================================================================================                                                   |  62%
  |                                                                                                                                            
  |====================================================================================                                                  |  63%
  |                                                                                                                                            
  |=====================================================================================                                                 |  64%
  |                                                                                                                                            
  |=======================================================================================                                               |  65%
  |                                                                                                                                            
  |========================================================================================                                              |  65%
  |                                                                                                                                            
  |=========================================================================================                                             |  66%
  |                                                                                                                                            
  |==========================================================================================                                            |  67%
  |                                                                                                                                            
  |===========================================================================================                                           |  68%
  |                                                                                                                                            
  |============================================================================================                                          |  69%
  |                                                                                                                                            
  |=============================================================================================                                         |  69%
  |                                                                                                                                            
  |==============================================================================================                                        |  70%
  |                                                                                                                                            
  |===============================================================================================                                       |  71%
  |                                                                                                                                            
  |================================================================================================                                      |  72%
  |                                                                                                                                            
  |=================================================================================================                                     |  72%
  |                                                                                                                                            
  |==================================================================================================                                    |  73%
  |                                                                                                                                            
  |===================================================================================================                                   |  74%
  |                                                                                                                                            
  |====================================================================================================                                  |  75%
  |                                                                                                                                            
  |=====================================================================================================                                 |  76%
  |                                                                                                                                            
  |======================================================================================================                                |  76%
  |                                                                                                                                            
  |=======================================================================================================                               |  77%
  |                                                                                                                                            
  |========================================================================================================                              |  78%
  |                                                                                                                                            
  |==========================================================================================================                            |  79%
  |                                                                                                                                            
  |===========================================================================================================                           |  80%
  |                                                                                                                                            
  |============================================================================================================                          |  80%
  |                                                                                                                                            
  |=============================================================================================================                         |  81%
  |                                                                                                                                            
  |==============================================================================================================                        |  82%
  |                                                                                                                                            
  |===============================================================================================================                       |  83%
  |                                                                                                                                            
  |================================================================================================================                      |  83%
  |                                                                                                                                            
  |=================================================================================================================                     |  84%
  |                                                                                                                                            
  |==================================================================================================================                    |  85%
  |                                                                                                                                            
  |===================================================================================================================                   |  86%
  |                                                                                                                                            
  |====================================================================================================================                  |  87%
  |                                                                                                                                            
  |=====================================================================================================================                 |  87%
  |                                                                                                                                            
  |======================================================================================================================                |  88%
  |                                                                                                                                            
  |=======================================================================================================================               |  89%
  |                                                                                                                                            
  |========================================================================================================================              |  90%
  |                                                                                                                                            
  |=========================================================================================================================             |  91%
  |                                                                                                                                            
  |==========================================================================================================================            |  91%
  |                                                                                                                                            
  |===========================================================================================================================           |  92%
  |                                                                                                                                            
  |=============================================================================================================================         |  93%
  |                                                                                                                                            
  |==============================================================================================================================        |  94%
  |                                                                                                                                            
  |===============================================================================================================================       |  94%
  |                                                                                                                                            
  |================================================================================================================================      |  95%
  |                                                                                                                                            
  |=================================================================================================================================     |  96%
  |                                                                                                                                            
  |==================================================================================================================================    |  97%
  |                                                                                                                                            
  |===================================================================================================================================   |  98%
  |                                                                                                                                            
  |====================================================================================================================================  |  98%
  |                                                                                                                                            
  |===================================================================================================================================== |  99%
  |                                                                                                                                            
  |======================================================================================================================================| 100%
```

``` r
clu_gmm <- daltoolbox::cluster(model_gmm, X)

# classificação
table(clu_gmm)
```

```
## clu_gmm
##   1   2 
##  50 100
```

``` r
# log-likelihood (EM)
head(model_gmm$model$loglik)
```

```
## [1] -215.726
```

## Clustering Fuzzy
Permite que cada ponto pertença a múltiplos clusters com diferentes graus de pertinência.  
Slides: 50–51.


``` r
# Slides 50–51: clustering fuzzy (cmeans)
set.seed(1)
model_fuzzy <- cluster_cmeans(centers = 3, m = 2)
model_fuzzy <- daltoolbox::fit(model_fuzzy, X)
clu_fuzzy <- daltoolbox::cluster(model_fuzzy, X)

table(clu_fuzzy)
```

```
## clu_fuzzy
##  1  2  3 
## 60 40 50
```

## Clustering em Grafos
Comunidades em redes podem ser detectadas por métodos como Louvain.  
Slides: 63–64.


``` r
# Slides 63–64: clustering de grafos e redes (exemplo simples)
set.seed(1)
g <- igraph::sample_gnp(n = 20, p = 0.15)
model_louvain <- cluster_louvain_graph()
model_louvain <- daltoolbox::fit(model_louvain, g)
comm <- daltoolbox::cluster(model_louvain, g)
length(unique(comm))
```

```
## [1] 6
```

``` r
# Grupos de comunidade
comm
```

```
##  [1] 1 2 3 2 1 4 5 1 6 4 3 5 5 2 4 1 4 3 2 3
## attr(,"metric")
## [1] 0.3571429 0.3973214
```

## Referências
- Han, J., Pei, J., & Tong, H. (2022). *Data Mining: Concepts and Techniques* (4th ed.). Morgan Kaufmann.
- MacQueen, J. (1967). Some Methods for Classification and Analysis of Multivariate Observations. *Proc. 5th Berkeley Symposium*.
- Kaufman, L., & Rousseeuw, P. (1990). *Finding Groups in Data*. Wiley.
- Ester, M., Kriegel, H.-P., Sander, J., & Xu, X. (1996). DBSCAN. *KDD*.
- Fraley, C., & Raftery, A. (2002). Model-based clustering. *JASA*, 97(458), 611–631.
- Zadeh, L. (1965). Fuzzy sets. *Information and Control*, 8(3), 338–353.
- Blondel, V. et al. (2008). Fast unfolding of communities in large networks. *J. Statistical Mechanics*.





